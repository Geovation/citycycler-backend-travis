language: node_js
node_js:
- '6'
cache:
  directories:
  - node_modules
env:
  global:
  - NODE_ENV=staging
  - URL="https://matchmyroute-backend.appspot.com"
  # - secure: lUO4xwRNZTbTfMdobBYND9vvgrJNKyTAFsfAzuNoyb6gsJmbE+nK1nWXJwRfZv7zkf8FNEriSlTUhvHaXdlAoxnUJgZmQaeQZZUXPvoGLtSJReppI3Lk8BYRdvld+iAmnpgEAmw1AiVQv9X1U0T6nR4Tz6N9N8Qun3wSCqxmm5EdPSvZ8PukfJ8wXK4SPRRHYtbfbr8ys34SUBzgo0/PUblFpWZKeYhV40L6nhwZ1C1iczMrGvl6i8wEoPxQLLp9y4bcH1oNMYROCxPEg/i1BuDg8m0w/NHUY0AgIBZG3WpBgCZPPPn1wqvrdtYU5qikrJjLmSFZs+c9dvpxZOcLxGiWi4reqQ/ECy6GU/cx1SD1XIYKq2wle8cj2ZR+nAo3aLJDxs38c1QInhX+AkR8OV/xRcdKaHEEXHo/asjg5LgDhtJRUzDkePrlIqhOxVjIlyMkjOHtrACtPlFK1o/Stat6th2+1nhCvClx86ndRA8lvhHcDsvYY9bEWQKTPFzMNZzH/gAzVfqJSJEgZxAyHF/5cBEofoMuVPSyL/azaYJ1AwEdO6P94o7Y5mYaAnTFxHlcF/+bwMWsnwTsZyLhAcVqx7aKn40M+LP478lwdPge83+2ww3bGJMxa0ZhmXmy01rC5oGa/p5WE0sNkC6/xs2QEnruagJvZUXBPnFNS+c=
  - secure: AGOSLSLbL615LYqTi3NnYnYUAzcPzGwgRzhnUcCp+B3kTpWoos+H+akUS0CUp6wPmwf1GLefz5zoRFJi/CrLeJLTFebxOckwP8epuawkfdHpdecySRepfI3ioHxcpIeg9HZ8lV0WenS93imypVq7oteyLii4uWQRcG0wD1hgr/N9Jwt0+SDG1pR50boNHN3A1zGQkyEizO/X/t2rD9XRLzYHXyAsrEFaSr0b/AxpqqjylY2rr+rhpDsqUVnJ7zRlFlGGWgCh5EnKdZm4PFZ23PEP0V7uXlw41u5q3dMw9qIhhTstQyWkrp9BZ9wP8h8OrhKEqyAovk9C+9q8Lzeg8B83yH2HwzpSKPpaunOB0wkyO/WXEfb+zIC+nmYFQp6oKG25SJOxDEyOsTqWeDmBMHpAWUN3kt7tsjEoUwrG+B6B5ETjduCBLoXQ1PIah1TookjcfW2/8oWSb5TJCoDEcnTPOFhVpRKya3BV52aFXKsdmJ1ofOBxHwYImocQgbV57PLyZzu2NgWrAl9mM9DTbDrKBHOH0Q8dznvGHFBJkGdxzt6Aw4Y/QUznIvaSaGypI/oJA5IeI73SzfOXVNvUPTCiMMqTvLIdSiZdINj1d5ewu4Hao+FwhbcJdu/iZf/ruG8uU3RWE5+0wwRWrBq6VmANttkW76SP20w61bBJ4zc=
before_install:
- openssl aes-256-cbc -K $encrypted_6b1d22c161fd_key -iv $encrypted_6b1d22c161fd_iv
  -in ./conf/key-file.json.enc -out ./conf/key-file.json -d
- openssl aes-256-cbc -K $encrypted_bcb0da9ada9b_key -iv $encrypted_bcb0da9ada9b_iv
  -in ./conf/matchmyroute-backend-firebase-adminsdk-jm5jb-e33eab9419.json.enc -out
  ./conf/matchmyroute-backend-firebase-adminsdk-jm5jb-e33eab9419.json -d
addons:
  postgresql: '9.6'
  apt:
    packages:
    - postgresql-9.6-postgis-2.3
before_script:
- psql -U postgres -c "create extension postgis"
- psql -c "CREATE USER testuser WITH PASSWORD 'test' SUPERUSER;"
- psql -c 'CREATE DATABASE "matchMyRouteTest" WITH OWNER testuser;'
script:
- npm run test
- npm run build
deploy:
  provider: gae
  keyfile: "./conf/key-file.json"
  project: matchmyroute-backend
  config: "./build/app.yaml"
  skip_cleanup: true
after_deploy:
- npm run e2etest
